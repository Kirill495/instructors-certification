<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${protocol.id == null ? 'Создать протокол' : 'Редактировать протокол'}">Протокол</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Add Select2 for autocomplete -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <style>
        .content-row {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        .row-number {
            font-weight: bold;
            color: #0d6efd;
        }
        .delete-row-btn {
            cursor: pointer;
        }
        .select2-container {
            width: 100% !important;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1 class="mb-4" th:text="${protocol.id == 0 ? 'Создать протокол' : 'Редактировать протокол'}">
        Создать протокол
    </h1>

    <form th:action="@{/protocols/save}" th:object="${protocol}" method="post" id="protocolForm">

        <!-- Hidden ID field -->
        <input type="hidden" th:field="*{id}">

        <!-- Protocol Header -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Данные протокола</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="number" class="form-label">Номер протокола <span class="text-danger">*</span></label>
                        <input type="text"
                               class="form-control"
                               id="number"
                               th:field="*{number}"
                               required
                               placeholder="Например: 01/2024">
                    </div>

                    <div class="col-md-4">
                        <label for="date" class="form-label">Дата <span class="text-danger">*</span></label>
                        <input type="date"
                               class="form-control"
                               id="date"
                               th:field="*{date}"
                               required>
                    </div>

                    <div class="col-md-4">
                        <label for="orderNumber" class="form-label">Номер приказа</label>
                        <input type="text"
                               class="form-control"
                               id="orderNumber"
                               th:field="*{order}"
                               placeholder="Например: 123">
                    </div>
                </div>
            </div>
        </div>

        <!-- Protocol Content Rows -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Табличная часть: Туристы</h5>
                <button type="button" class="btn btn-light btn-sm" onclick="addRow()">
                    <i class="bi bi-plus-circle"></i> Добавить строку
                </button>
            </div>
            <div class="card-body">
                <div id="contentRowsContainer">
                    <!-- Existing rows will be rendered here -->
                    <div th:each="row, iterStat : *{contentRows}"
                         th:id="'row-' + ${iterStat.index}"
                         class="content-row">

                        <div class="d-flex justify-content-between mb-2">
                            <span class="row-number">Строка <span th:text="${iterStat.index + 1}">1</span></span>
                            <button type="button"
                                    class="btn btn-danger btn-sm delete-row-btn"
                                    th:onclick="'deleteRow(' + ${iterStat.index} + ')'">
                                <i class="bi bi-trash"></i> Удалить
                            </button>
                        </div>

                        <!-- Hidden fields -->
                        <input type="hidden" th:field="*{contentRows[__${iterStat.index}__].protocolId}">
                        <input type="hidden"
                               th:field="*{contentRows[__${iterStat.index}__].rowNum}"
                               th:value="${iterStat.index + 1}">

                        <div class="row">
                            <!-- Tourist - with autocomplete -->
                            <div class="col-md-3">
                                <label class="form-label">Турист <span class="text-danger">*</span></label>
                                <select class="form-select tourist-select"
                                        th:field="*{contentRows[__${iterStat.index}__].touristId}"
                                        required>
                                    <!-- For edit mode - show selected tourist -->
                                    <option th:if="${row.touristId != null}"
                                            th:value="${row.touristId}"
                                            th:text="${row.touristFullName}"
                                            selected>
                                    </option>
                                </select>
                            </div>

                            <!-- Kind of Tourism -->
                            <div class="col-md-3">
                                <label class="form-label">Вид туризма <span class="text-danger">*</span></label>
                                <select class="form-select"
                                        th:field="*{contentRows[__${iterStat.index}__].kindOfTourismId}"
                                        required>
                                    <option value="">Выберите...</option>
                                    <option th:each="kind : ${kindsOfTourism}"
                                            th:value="${kind.id}"
                                            th:text="${kind.title}">
                                    </option>
                                </select>
                            </div>

                            <!-- Grade -->
                            <div class="col-md-3">
                                <label class="form-label">Звание <span class="text-danger">*</span></label>
                                <select class="form-select"
                                        th:field="*{contentRows[__${iterStat.index}__].gradeId}"
                                        required>
                                    <option value="">Выберите...</option>
                                    <option th:each="grade : ${grades}"
                                            th:value="${grade.id}"
                                            th:text="${grade.title}">
                                    </option>
                                </select>
                            </div>

                            <!-- Certification ID -->
                            <div class="col-md-3">
<!--                                <label class="form-label">№ удостоверения</label>-->
                                <input type="text"
                                       class="form-control"
                                       th:field="*{contentRows[__${iterStat.index}__].certificationId}"
                                       maxlength="10"
                                       placeholder="№ удостоверения">
                            </div>
                        </div>

                        <div class="row mt-2">
                            <!-- Club -->
                            <div class="col-md-6">
<!--                                <label class="form-label">Клуб</label>-->
                                <input type="text"
                                       class="form-control"
                                       th:field="*{contentRows[__${iterStat.index}__].club}"
                                       placeholder="Клуб (школа)">
                            </div>

                        </div>
                    </div>

                    <!-- Empty state -->
                    <div id="emptyState" th:if="${protocol.contentRows.isEmpty()}" class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Нет строк. Нажмите "Добавить строку" для начала.
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Buttons -->
        <div class="d-flex justify-content-between mb-5">
            <a href="/protocols" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Отмена
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-save"></i>
                <span th:text="${protocol.id == null ? 'Создать протокол' : 'Сохранить изменения'}">Сохранить</span>
            </button>
        </div>
    </form>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Template for new row (hidden) -->
<template id="rowTemplate">
    <div class="content-row" id="row-{INDEX}">
        <div class="d-flex justify-content-between mb-2">
            <span class="row-number">Строка <span>{ROW_NUM}</span></span>
            <button type="button" class="btn btn-danger btn-sm delete-row-btn" onclick="deleteRow({INDEX})">
                <i class="bi bi-trash"></i> Удалить
            </button>
        </div>

        <input type="hidden" name="contentRows[{INDEX}].protocolId" value="">
        <input type="hidden" name="contentRows[{INDEX}].rowNum" value="{ROW_NUM}">

        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Турист <span class="text-danger">*</span></label>
                <select class="form-select tourist-select"
                        name="contentRows[{INDEX}].touristId"
                        id="tourist-{INDEX}"
                        required>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Вид туризма <span class="text-danger">*</span></label>
                <select class="form-select" name="contentRows[{INDEX}].kindOfTourismId" required>
                    <option value="">Выберите...</option>
                    <th:block th:each="kind : ${kindsOfTourism}">
                        <option th:value="${kind.id}" th:text="${kind.title}"></option>
                    </th:block>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Звание <span class="text-danger">*</span></label>
                <select class="form-select" name="contentRows[{INDEX}].gradeId" required>
                    <option value="">Выберите...</option>
                    <th:block th:each="grade : ${grades}">
                        <option th:value="${grade.id}" th:text="${grade.title}"></option>
                    </th:block>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">№ удостоверения</label>
                <input type="text" class="form-control" name="contentRows[{INDEX}].certificationId" maxlength="10" placeholder="12345">
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-md-6">
                <label class="form-label">Клуб</label>
                <input type="text" class="form-control" name="contentRows[{INDEX}].club" placeholder="Название клуба">
            </div>
        </div>
    </div>
</template>

<script th:inline="javascript">
    let rowIndex = /*[[${protocol.contentRows.size()}]]*/ 0;

    // Initialize Select2 for existing rows on page load
    $(document).ready(function() {
        initializeSelect2($('.tourist-select'));
    });

    // Initialize Select2 with AJAX for tourist search
    function initializeSelect2(element) {
        element.select2({
            theme: 'bootstrap-5',
            ajax: {
                url: '/api/tourists/search',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        query: params.term // search term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.map(function(tourist) {
                            return {
                                id: tourist.id,
                                text: tourist.fullName
                            };
                        })
                    };
                },
                cache: true
            },
            placeholder: 'Начните вводить имя туриста...',
            minimumInputLength: 2,
            language: {
                inputTooShort: function () {
                    return 'Введите минимум 2 символа';
                },
                searching: function () {
                    return 'Поиск...';
                },
                noResults: function () {
                    return 'Туристы не найдены';
                }
            }
        });
    }

    function addRow() {
        // Hide empty state
        const emptyState = document.getElementById('emptyState');
        if (emptyState) {
            emptyState.style.display = 'none';
        }

        // Get template
        const template = document.getElementById('rowTemplate');
        let rowHtml = template.innerHTML;

        // Replace placeholders
        rowHtml = rowHtml.replaceAll('{INDEX}', rowIndex);
        rowHtml = rowHtml.replaceAll('{ROW_NUM}', rowIndex + 1);

        // Add to container
        const container = document.getElementById('contentRowsContainer');
        container.insertAdjacentHTML('beforeend', rowHtml);

        // Initialize Select2 for the new tourist select
        const newSelect = $('#tourist-' + rowIndex);
        initializeSelect2(newSelect);

        rowIndex++;
    }

    function deleteRow(index) {
        if (confirm('Вы уверены, что хотите удалить эту строку?')) {
            const row = document.getElementById('row-' + index);

            // Destroy Select2 before removing row
            $(row).find('.tourist-select').select2('destroy');

            row.remove();

            // Show empty state if no rows left
            const container = document.getElementById('contentRowsContainer');
            const rows = container.querySelectorAll('.content-row');
            if (rows.length === 0) {
                const emptyState = document.getElementById('emptyState');
                if (emptyState) {
                    emptyState.style.display = 'block';
                }
            }

            // Renumber remaining rows
            renumberRows();
        }
    }

    function renumberRows() {
        const rows = document.querySelectorAll('.content-row');
        rows.forEach((row, index) => {
            const rowNumSpan = row.querySelector('.row-number span');
            if (rowNumSpan) {
                rowNumSpan.textContent = index + 1;
            }

            const rowNumInput = row.querySelector('input[name$=".rowNum"]');
            if (rowNumInput) {
                rowNumInput.value = index + 1;
            }
        });
    }
</script>
</body>
</html>