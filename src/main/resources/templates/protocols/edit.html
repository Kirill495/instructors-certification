<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${protocol.isNewItem() ? 'Создать протокол' : 'Редактировать протокол'}">Протокол</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Add Select2 for autocomplete -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <style>
        /* Table styling for Excel-like appearance */
        .protocol-table {
            width: 100%;
            border-collapse: collapse;
        }

        .protocol-table thead th {
            background-color: #e9ecef;
            font-weight: 600;
            padding: 8px;
            border: 1px solid #dee2e6;
            text-align: left;
            vertical-align: middle;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .protocol-table tbody td {
            padding: 4px;
            border: 1px solid #dee2e6;
            vertical-align: middle;
        }

        .protocol-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Make form controls fit table cells */
        .protocol-table select,
        .protocol-table input[type="text"] {
            width: 100%;
            border: 1px solid #ced4da;
            padding: 4px 8px;
            font-size: 14px;
        }

        .protocol-table select:focus,
        .protocol-table input[type="text"]:focus {
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        /* Row number column */
        .row-num-cell {
            width: 50px;
            text-align: center;
            background-color: #f8f9fa;
            font-weight: 500;
            color: #6c757d;
        }

        /* Delete button column */
        .delete-cell {
            width: 60px;
            text-align: center;
        }

        .delete-cell .btn {
            padding: 2px 8px;
            font-size: 12px;
        }

        /* Column widths */
        .tourist-col { width: 25%; }
        .kind-col { width: 20%; }
        .grade-col { width: 20%; }
        .cert-col { width: 15%; }
        .club-col { width: 20%; }

        /* Select2 customization for table */
        .select2-container {
            width: 100% !important;
        }

        .select2-container--bootstrap-5 .select2-selection {
            min-height: 31px;
            padding: 2px 8px;
            font-size: 14px;
        }

        /* Table container with scrolling */
        .table-container {
            max-height: calc(100vh - 400px);
            overflow-y: auto;
            margin-bottom: 10px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
    </style>
</head>
<body>
<div class="container-fluid mt-4">
    <h1 class="mb-4" th:text="${protocol.isNewItem() ? 'Новый протокол' : 'Редактировать протокол'}">
        Создать протокол
    </h1>

    <form th:action="@{/protocols/save}" th:object="${protocol}" method="post" id="protocolForm">

        <!-- Hidden ID field -->
        <input type="hidden" th:field="*{id}">

        <!-- Protocol Header -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="number" class="form-label">Номер протокола <span class="text-danger">*</span></label>
                        <input type="text"
                               class="form-control"
                               id="number"
                               th:field="*{number}"
                               required
                               placeholder="Например: 01/2024">
                    </div>

                    <div class="col-md-4">
                        <label for="date" class="form-label">Дата <span class="text-danger">*</span></label>
                        <input type="date"
                               class="form-control"
                               id="date"
                               th:field="*{date}"
                               required>
                    </div>

                    <div class="col-md-4">
                        <label for="orderNumber" class="form-label">Номер приказа</label>
                        <input type="text"
                               class="form-control"
                               id="orderNumber"
                               th:field="*{order}"
                               placeholder="Например: 123">
                    </div>
                </div>
            </div>
        </div>

        <!-- Protocol Content Table -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Туристы</h5>
                <button type="button" class="btn btn-light btn-sm" onclick="addRow()">
                    <i class="bi bi-plus-circle"></i> Добавить строку
                </button>
            </div>
            <div class="card-body p-0">
                <!-- Empty state -->
                <div id="emptyState" th:if="${protocol.contentRows.isEmpty()}" class="empty-state">
                    <i class="bi bi-info-circle fs-1 mb-3 d-block"></i>
                    <p>Нет строк. Нажмите "Добавить строку" для начала.</p>
                </div>

                <!-- Table container -->
                <div class="table-container" th:unless="${protocol.contentRows.isEmpty()}">
                    <table class="protocol-table" id="protocolTable">
                        <thead>
                        <tr>
                            <th class="row-num-cell">#</th>
                            <th class="tourist-col">Турист <span class="text-danger">*</span></th>
                            <th class="kind-col">Вид туризма <span class="text-danger">*</span></th>
                            <th class="grade-col">Звание <span class="text-danger">*</span></th>
                            <th class="cert-col">№ удостоверения</th>
                            <th class="club-col">Клуб</th>
                            <th class="delete-cell"></th>
                        </tr>
                        </thead>
                        <tbody id="tableBody">
                        <!-- Existing rows -->
                        <tr th:each="row, iterStat : *{contentRows}" th:id="'row-' + ${iterStat.index}">
                            <!-- Row number -->
                            <td class="row-num-cell">
                                <span class="row-number" th:text="${iterStat.index + 1}">1</span>
                            </td>

                            <!-- Hidden fields -->
                            <input type="hidden" th:field="*{contentRows[__${iterStat.index}__].protocolId}">
                            <input type="hidden"
                                   th:field="*{contentRows[__${iterStat.index}__].rowNum}"
                                   th:value="${iterStat.index + 1}"
                                   class="row-num-input">

                            <!-- Tourist -->
                            <td>
                                <select class="tourist-select"
                                        th:field="*{contentRows[__${iterStat.index}__].touristId}"
                                        required>
                                    <option th:if="${row.touristId != null}"
                                            th:value="${row.touristId}"
                                            th:text="${row.touristFullName}"
                                            selected>
                                    </option>
                                </select>
                            </td>

                            <!-- Kind of Tourism -->
                            <td>
                                <select th:field="*{contentRows[__${iterStat.index}__].kindOfTourismId}"
                                        required>
                                    <option value="">Выберите...</option>
                                    <option th:each="kind : ${kindsOfTourism}"
                                            th:value="${kind.id}"
                                            th:text="${kind.title}">
                                    </option>
                                </select>
                            </td>

                            <!-- Grade -->
                            <td>
                                <select th:field="*{contentRows[__${iterStat.index}__].gradeId}"
                                        required>
                                    <option value="">Выберите...</option>
                                    <option th:each="grade : ${grades}"
                                            th:value="${grade.id}"
                                            th:text="${grade.title}">
                                    </option>
                                </select>
                            </td>

                            <!-- Certification ID -->
                            <td>
                                <input type="text"
                                       th:field="*{contentRows[__${iterStat.index}__].certificationId}"
                                       maxlength="10"
                                       placeholder="12345">
                            </td>

                            <!-- Club -->
                            <td>
                                <input type="text"
                                       th:field="*{contentRows[__${iterStat.index}__].club}"
                                       placeholder="Клуб">
                            </td>

                            <!-- Delete button -->
                            <td class="delete-cell">
                                <button type="button"
                                        class="btn btn-danger btn-sm"
                                        th:onclick="'deleteRow(' + ${iterStat.index} + ')'">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Add row button at bottom -->
                <div class="p-3 border-top" th:unless="${protocol.contentRows.isEmpty()}">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addRow()">
                        <i class="bi bi-plus-circle"></i> Добавить строку
                    </button>
                </div>
            </div>
        </div>

        <!-- Form Buttons -->
        <div class="d-flex justify-content-between mb-5">
            <a href="/protocols" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Отмена
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-save"></i>
                <span th:text="${protocol.isNewItem() ? 'Создать протокол' : 'Сохранить изменения'}">Сохранить</span>
            </button>
        </div>
    </form>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Template for new row (hidden) -->
<template id="rowTemplate">
    <tr id="row-{INDEX}">
        <!-- Row number -->
        <td class="row-num-cell">
            <span class="row-number">{ROW_NUM}</span>
        </td>

        <!-- Hidden fields -->
        <input type="hidden" name="contentRows[{INDEX}].protocolId" value="">
        <input type="hidden" name="contentRows[{INDEX}].rowNum" value="{ROW_NUM}" class="row-num-input">

        <!-- Tourist -->
        <td>
            <select class="tourist-select"
                    name="contentRows[{INDEX}].touristId"
                    id="tourist-{INDEX}"
                    required>
            </select>
        </td>

        <!-- Kind of Tourism -->
        <td>
            <select name="contentRows[{INDEX}].kindOfTourismId" required>
                <option value="">Выберите...</option>
                <th:block th:each="kind : ${kindsOfTourism}">
                    <option th:value="${kind.id}" th:text="${kind.title}"></option>
                </th:block>
            </select>
        </td>

        <!-- Grade -->
        <td>
            <select name="contentRows[{INDEX}].gradeId" required>
                <option value="">Выберите...</option>
                <th:block th:each="grade : ${grades}">
                    <option th:value="${grade.id}" th:text="${grade.title}"></option>
                </th:block>
            </select>
        </td>

        <!-- Certification ID -->
        <td>
            <input type="text" name="contentRows[{INDEX}].certificationId" maxlength="10" placeholder="12345">
        </td>

        <!-- Club -->
        <td>
            <input type="text" name="contentRows[{INDEX}].club" placeholder="Клуб">
        </td>

        <!-- Delete button -->
        <td class="delete-cell">
            <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow({INDEX})">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    </tr>
</template>

<script th:inline="javascript">
    let rowIndex = /*[[${protocol.contentRows.size()}]]*/ 0;

    // Initialize Select2 for existing rows on page load
    $(document).ready(function() {
        initializeSelect2($('.tourist-select'));
    });

    // Initialize Select2 with AJAX for tourist search
    function initializeSelect2(element) {
        element.select2({
            theme: 'bootstrap-5',
            ajax: {
                url: '/api/tourists/search',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        query: params.term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.map(function(tourist) {
                            return {
                                id: tourist.id,
                                text: tourist.fullName,
                                certificationId: tourist.certificationId  // Store certificationId in the option
                            };
                        })
                    };
                },
                cache: true
            },
            placeholder: 'Начните вводить имя...',
            minimumInputLength: 2,
            language: {
                inputTooShort: function () {
                    return 'Введите минимум 2 символа';
                },
                searching: function () {
                    return 'Поиск...';
                },
                noResults: function () {
                    return 'Туристы не найдены';
                }
            }
        }).on('select2:select', function (e) {
            // When a tourist is selected, auto-fill the certification ID
            const selectedData = e.params.data;
            const certificationId = selectedData.certificationId;

            // Find the certification ID input in the same row
            const row = $(this).closest('tr');
            const certInput = row.find('input[name$=".certificationId"]');

            // Auto-fill only if the field is empty
            if (certInput.length && !certInput.val()) {
                certInput.val(certificationId || '');
            }
        });
    }

    function addRow() {
        // Hide/show empty state and table
        const emptyState = document.getElementById('emptyState');
        const tableContainer = document.querySelector('.table-container');
        const tableBody = document.getElementById('tableBody');

        if (emptyState && emptyState.style.display !== 'none') {
            emptyState.style.display = 'none';
            // Create table if it doesn't exist
            if (!tableContainer) {
                const cardBody = document.querySelector('.card-body.p-0');
                const container = document.createElement('div');
                container.className = 'table-container';
                container.innerHTML = `
                    <table class="protocol-table" id="protocolTable">
                        <thead>
                            <tr>
                                <th class="row-num-cell">#</th>
                                <th class="tourist-col">Турист <span class="text-danger">*</span></th>
                                <th class="kind-col">Вид туризма <span class="text-danger">*</span></th>
                                <th class="grade-col">Звание <span class="text-danger">*</span></th>
                                <th class="cert-col">№ удостоверения</th>
                                <th class="club-col">Клуб</th>
                                <th class="delete-cell"></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                `;
                cardBody.appendChild(container);

                // Add bottom button
                const bottomButton = document.createElement('div');
                bottomButton.className = 'p-3 border-top';
                bottomButton.innerHTML = `
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addRow()">
                        <i class="bi bi-plus-circle"></i> Добавить строку
                    </button>
                `;
                cardBody.appendChild(bottomButton);
            }
        }

        // Get template
        const template = document.getElementById('rowTemplate');
        let rowHtml = template.innerHTML;

        // Replace placeholders
        rowHtml = rowHtml.replaceAll('{INDEX}', rowIndex);
        rowHtml = rowHtml.replaceAll('{ROW_NUM}', rowIndex + 1);

        // Add to table body
        const tbody = document.getElementById('tableBody') || document.querySelector('#protocolTable tbody');
        tbody.insertAdjacentHTML('beforeend', rowHtml);

        // Initialize Select2 for the new tourist select
        const newSelect = $('#tourist-' + rowIndex);
        initializeSelect2(newSelect);

        rowIndex++;
    }

    function deleteRow(index) {
        if (confirm('Вы уверены, что хотите удалить эту строку?')) {
            const row = document.getElementById('row-' + index);

            // Destroy Select2 before removing row
            $(row).find('.tourist-select').select2('destroy');

            row.remove();

            // Show empty state if no rows left
            const tbody = document.getElementById('tableBody');
            const rows = tbody ? tbody.querySelectorAll('tr') : [];

            if (rows.length === 0) {
                const emptyState = document.getElementById('emptyState');
                const tableContainer = document.querySelector('.table-container');
                const bottomButton = document.querySelector('.p-3.border-top');

                if (emptyState) {
                    emptyState.style.display = 'block';
                }
                if (tableContainer) {
                    tableContainer.remove();
                }
                if (bottomButton) {
                    bottomButton.remove();
                }
            }

            // Renumber remaining rows
            renumberRows();
        }
    }

    function renumberRows() {
        const rows = document.querySelectorAll('#tableBody tr');
        rows.forEach((row, index) => {
            const rowNumSpan = row.querySelector('.row-number');
            if (rowNumSpan) {
                rowNumSpan.textContent = index + 1;
            }

            const rowNumInput = row.querySelector('.row-num-input');
            if (rowNumInput) {
                rowNumInput.value = index + 1;
            }
        });
    }
</script>
</body>
</html>